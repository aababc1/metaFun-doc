(BIN_ASSESSMENT_description)=

# BIN_ASSESSMENT

This Nextflow script implements a workflow for assessing genome quality and assigning taxonomy to metagenome-assembled genomes (MAGs).

## Workflow Execution

```{code-block} bash
:caption: BIN_ASSESSMENT execution

# Activate metafun conda environment
conda activate metafun
# Move to metafun directory where you cloned metafun from GitHub
# Run the BIN_ASSESSMENT workflow
nextflow run nf_scripts/BIN_ASSESSMENT_apptainer.nf --metadata "${your metadata}" --accession_column "${your accessioncolumn}"
```

## Workflow Overview

This workflow performs the following steps:

1. Genome quality assessment using CheckM2
2. Genome contamination assessment using GUNC
3. Combining CheckM2 and GUNC results and filtering high-quality genomes
4. Taxonomic classification using GTDB-Tk
5. Combining quality assessment and taxonomic classification results
6. Optional: Combining results with user-provided metadata

## Inputs and Outputs

**Inputs**: 
- Assembled genomic fasta files (`.fa`) from the ASSEMBLY_BINNING workflow
- Optional: User-provided metadata file

**Outputs**: 
- CheckM2 quality assessment results
- GUNC contamination assessment results
- Combined quality assessment report
- High-quality genome fasta files
- GTDB-Tk taxonomic classification results
- Final combined quality and taxonomy report
- Optional: Combined metadata and quality/taxonomy report

Default input directory: `${launchDir}/results/metagenome/ASSEMBLY_BINNING/final_bins`
Default output directory: `${launchDir}/results/metagenome/BIN_ASSESSMENT`

| Process | InputDir | OutputDir | Note |
|---------|----------|-----------|------|
| runCheckM2 | `${params.inputDir}` | `${params.outdir}/checkm2_${params.run_id}` | CheckM2 quality assessment |
| runGUNC | Output from runCheckM2 | `${params.outdir}/gunc_${params.run_id}` | GUNC contamination assessment |
| combineFiles | Outputs from runCheckM2 and runGUNC | `${params.outdir}/checkm_gunc_combined_${params.run_id}` | Combines and filters results |
| gtdbtk | High-quality genomes from combineFiles | `${params.outdir}/gtdb_outdir_${params.run_id}` | GTDB-Tk taxonomic classification |
| createFinalFile | Outputs from gtdbtk | `${params.outdir}` | Creates final combined report |
| combineMetadata | Final report and user metadata | `${launchDir}` | Optional: Combines with user metadata |

## Parameters in BIN_ASSESSMENT Nextflow Script

| Parameter | Description | Default Value | Note |
|-----------|-------------|---------------|------|
| `db_baseDir` | Base directory for databases | `/opt/database` | Mounted path in apptainer environment |
| `scripts_baseDir` | Base directory for scripts | `/scratch/tools/microbiome_analysis/scripts` | Mounted path in apptainer environment |
| `inputDir` | Input directory | `${params.outdir_Base}/results/metagenome/ASSEMBLY_BINNING/final_bins` | Contains assembled genomic fasta files |
| `outdir` | Output directory | `${params.outdir_Base}/results/metagenome/BIN_ASSESSMENT` | Where results will be stored |
| `GUNCdb` | GUNC database file | `${params.db_baseDir}/gunc/gunc_db_progenomes2.1.dmnd` | GUNC database file |
| `checkm2db` | CheckM2 database file | `${params.db_baseDir}/checkm2/CheckM2_database/uniref100.KO.1.dmnd` | CheckM2 database file |
| `cpus` | Number of CPUs to use | 76 | Used for parallel processing |
| `metadata` | Path to metadata file | null | Optional: User-provided metadata file |
| `accession_column` | Column index for accession in metadata | 1 | Used when combining with metadata |
| `run_id` | Unique identifier for the run | Generated based on date and workflow name | Used to distinguish between different runs |

## Descriptions of Processes in BIN_ASSESSMENT Workflow

1. **runCheckM2**: Performs genome quality assessment using CheckM2.
   - Input: Directory containing genome fasta files
   - Output: CheckM2 quality report
   - Key parameters: `--threads ${params.cpus}`, `--database_path ${params.checkm2db}`

2. **runGUNC**: Assesses genome contamination using GUNC.
   - Input: Protein files generated by CheckM2
   - Output: GUNC contamination report
   - Key parameters: `-t ${task.cpus}`, `--db_file ${params.GUNCdb}`

3. **combineFiles**: Combines CheckM2 and GUNC results, filters high-quality genomes.
   - Input: CheckM2 and GUNC reports
   - Output: Combined quality report, high-quality genome fasta files
   - Uses custom Python script: `Checkm2_GUNC_combine_quality_pass.py`

4. **gtdbtk**: Performs taxonomic classification using GTDB-Tk.
   - Input: High-quality genome fasta files
   - Output: GTDB-Tk classification results
   - Key parameters: `--mash_db ${params.db_baseDir}/gtdb/release220/mash_220.db.msh`, `--cpus ${task.cpus}`

5. **createFinalFile**: Creates a final combined report of quality assessment and taxonomic classification.
   - Input: Combined quality report and GTDB-Tk results
   - Output: Final quality and taxonomy report

6. **combineMetadata**: Optional step to combine results with user-provided metadata.
   - Input: Final quality and taxonomy report, user metadata file
   - Output: Combined metadata and quality/taxonomy report
   - Uses custom Python script: `combine_metadata_WMS_genome.py`

## Tools Used in BIN_ASSESSMENT

| Tool | Purpose | Version | Default parameters | Parameters that can be selected |
|------|---------|---------|---------------------|--------------------------------|
| CheckM2 | Genome quality assessment | 1.0.2 | Database version 1.0.2 | `--threads`, `--database_path` |
| GUNC | Genome contamination assessment | Not specified | Database: progenomes2.1 diamond | `-t`, `--db_file` |
| GTDB-Tk | Taxonomic classification | r220 | Default GTDB-Tk parameters | `--cpus`, `--mash_db` |

## Usage Notes

- The script checks for the existence and non-emptiness of the input directory before proceeding.
- To generate a genome metadata table for use in COMPARATIVE_ANNOTATION, specify the `--metadata` option and the `--accession_column`.
- The final metadata file (when using the `--metadata` option) will be named `quality_taxonomy_combined_${params.run_id}.csv`.
- This workflow is designed to work with the output from the ASSEMBLY_BINNING workflow.
- The script uses Apptainer (formerly Singularity) containers for tool execution, ensuring reproducibility across different computational environments.
- Error handling: The CheckM2 process includes error retry strategy with a maximum of 3 retries.

## Output Files Details

1. CheckM2 results: 
   - Location: `${params.outdir}/checkm2_${params.run_id}/`
   - Key file: `quality_report.tsv`

2. GUNC results: 
   - Location: `${params.outdir}/gunc_${params.run_id}/`
   - Key file: `GUNC.progenomes_2.1.maxCSS_level.tsv`

3. Combined CheckM2 and GUNC report: 
   - Location: `${params.outdir}/checkm_gunc_combined_${params.run_id}/`
   - Key file: `combined_report.tsv`

4. GTDB-Tk results: 
   - Location: `${params.outdir}/gtdb_outdir_${params.run_id}/`
   - Key files: `gtdbtk.bac120.summary.tsv`, `gtdbtk.ar53.summary.tsv`

5. Final quality and taxonomy report: 
   - Location: `${params.outdir}/`
   - File: `quality_taxonomy_combined_final.csv`

6. Optional combined metadata and quality/taxonomy report: 
   - Location: `${launchDir}/`
   - File: `combined_metadata_quality_taxonomy.csv`

For more detailed information about this workflow, please visit the [BIN_ASSESSMENT documentation](https://metafun-doc.readthedocs.io/en/latest/workflows/BIN_ASSESSMENT.html).